#!/usr/bin/env python

"""An agent for saga-pilot (sinon).
"""

__author__    = "Ole Weidner"
__email__     = "ole.weidner@rutgers.edu"
__copyright__ = "Copyright 2013, The RADICAL Project at Rutgers"
__license__   = "MIT"

import sys
import sinon
import logging
import optparse

def get_data(logger, session_id, database_url, database_name):
    """Returns timing data for pilots and compute units.
    """
    # pilot data is a list of dictionaries for each pilot:
    #[
    #    {  'id'     : <ID>,
    #       'name'   : <NAME>,
    #       'cores'  : <CORES_PER_NODE>
    #       'nodes'  : ['node1', 'node2', 'node3'], 
    #       'timing' : { 
    #           'scheduled': <TIME>, 
    #           'started'  : <TIME>, 
    #           'stopped'  : <TIME>
    #        } 
    #    }
    #]
    pilot_data = []

    task_data  = []


    try: 
        session = sinon.Session(
            session_uid   = session_id,
            database_url  = database_url,
            database_name = database_name
        )
        logger.info("Connected to session %s" % session)

        # ------------------------------------------------------------
        # PILOTS
        for pmgr in session.get_pilot_managers():
            for pilot in pmgr.get_pilots():
                logger.info("Found pilot: %s" % pilot)

                res_details = pilot.resource_details

                pilot_data.append({
                    'id'     : pilot.uid,
                    'name'   : pilot.description['Resource'],
                    'cores'  : res_details['cores_per_node'],
                    'nodes'  : res_details['nodes'],
                    'timing' : {
                        'scheduled' : pilot.submission_time,
                        'started'   : pilot.start_time,
                        'stopped'   : pilot.stop_time,
                    } 
                })

        print pilot_data 

        # ------------------------------------------------------------
        # TASKS
        for umgr in session.get_unit_managers():
            tasks = umgr.get_units()
            logger.info("Found %s compute units." % len(tasks))
            for task in tasks:

                task_data.append({
                    'id'       : task.uid,
                    'name'     : pilot.description['Resource'],
                    'location_node' : task.execution_details,
                    'timing'   : {
                        'scheduled' : task.submission_time,
                        'started'   : task.start_time,
                        'stopped'   : task.stop_time,
                    } 
                })

        print task_data


    except sinon.SinonException, ex:
            logger.error(ex)
            sys.exit(255)

#-----------------------------------------------------------------------------
#
def setup_logger():
    """Configures the logging facility.

    Since this is a command line tool, we simply log to the console. 
    """
    logger = logging.getLogger('sinon-timeline')

    logger.setLevel(logging.INFO)
    ch = logging.StreamHandler()
    ch.setLevel(logging.INFO)

    format_string = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    formatter = logging.Formatter(format_string)
    
    ch.setFormatter(formatter)
    logger.addHandler(ch)

    return logger

#-----------------------------------------------------------------------------
#
def parse_commandline():

    usage = "usage: %prog -d -s [-n]"
    parser = optparse.OptionParser(usage=usage)

    parser.add_option('-d', '--mongodb-url',
                      metavar='URL',
                      dest='database_url',
                      help='Specifies the url of the MongoDB database.')

    parser.add_option('-n', '--database-name',
                      metavar='URL',
                      dest='database_name',
                      default='sinon',
                      help='Specifies the name of the database [default: %default].')

    parser.add_option('-s', '--session-id',
                      metavar='SID',
                      dest='session_id',
                      help='Specifies the id of the session you want to inspect')

    # parse the whole shebang
    (options, args) = parser.parse_args()

    if options.database_url is None:
        parser.error("You must define MongoDB URL (-d/--mongodb-url). Try --help for help.")
    elif options.database_name is None:
        parser.error("You must define a database name (-n/--database-name). Try --help for help.")
    elif options.session_id is None:
        parser.error("You must define a session id (-s/--session-id). Try --help for help.")

    return options

#-----------------------------------------------------------------------------
#
if __name__ == "__main__":

    options = parse_commandline()
    logger  = setup_logger()

    logger.info("hello from plotter")

    get_data(
        logger        = logger, 
        session_id    = options.session_id, 
        database_url  = options.database_url, 
        database_name = options.database_name
    )

    sys.exit(0)